<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>绘制几何图形</title>
  </head>
  <script charset="utf-8" src="https://map.qq.com/api/gljs?libraries=tools&v=1.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77"></script>
  <style type="text/css">
    html,
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
    }

    #container {
      width: 100%;
      height: 90%;
    }

    #toolControl {
      position: absolute;
      top: 10px;
      left: 0px;
      right: 0px;
      margin: auto;
      width: 252px;
      z-index: 1001;
    }

    .toolItem {
      width: 30px;
      height: 30px;
      float: left;
      margin: 1px;
      padding: 4px;
      border-radius: 3px;
      background-size: 30px 30px;
      background-position: 4px 4px;
      background-repeat: no-repeat;
      box-shadow: 0 1px 2px 0 #e4e7ef;
      background-color: #ffffff;
      border: 1px solid #ffffff;
    }

    .toolItem:hover {
      border-color: #789cff;
    }

    .active {
      border-color: #d5dff2;
      background-color: #d5dff2;
    }

    #marker {
      background-image: url('https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/marker_editor.png');
    }

    #polyline {
      background-image: url('https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/polyline.png');
    }

    #polygon {
      background-image: url('https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/polygon.png');
    }

    #circle {
      background-image: url('https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/circle.png');
    }

    #rectangle {
      background-image: url('https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/rectangle.png');
    }

    #ellipse {
      background-image: url('https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/ellipse.png');
    }
  </style>

  <body onload="initMap()">
    <div id="container"></div>
    <div id="toolControl">
      <div class="toolItem active" id="marker" title="点标记"></div>
      <div class="toolItem" id="polyline" title="折线"></div>
      <div class="toolItem" id="polygon" title="多边形"></div>
      <div class="toolItem" id="circle" title="圆形"></div>
      <div class="toolItem" id="rectangle" title="矩形"></div>
      <div class="toolItem" id="ellipse" title="椭圆"></div>
    </div>
    <div id="info">
      绘制：鼠标左键点击及移动即可绘制图形
      <br />
      结束绘制：鼠标左键双击即可结束绘制折线；多边形会自动闭合；圆形、矩形、椭圆单击即可结束
      <br />
      中断：绘制过程中按下esc键可中断该过程
      <br />
      撤销：使用ctrl+z或鼠标右键可以在绘制线和多边形时撤销上个绘制点
    </div>
    <script type="text/javascript">
      var map; // 地图
      var editor; // 编辑器
      var polyline; // 折线图层（全局，供 printPolyline 使用）
      var activeType = 'marker'; // 激活的图形编辑类型

      // 切换激活图层
      document.getElementById('toolControl').addEventListener('click', (e) => {
        var id = e.target.id;
        if (id !== 'toolControl') {
          document.getElementById(activeType).className = 'toolItem';
          document.getElementById(id).className = 'toolItem active';
          activeType = id;

          editor.setActiveOverlay(id);
        }
      });

      function initMap() {
        // 初始化地图
        map = new TMap.Map('container', {
          zoom: 13, // 设置地图缩放级别
          center: new TMap.LatLng(34.752433,113.667987), // 设置地图中心点坐标
        });

        // map.setCenter(new TMap.LatLng(34.752433,113.667987));
        // map.setZoom(13);

        // 初始化几何图形及编辑器
        var marker = new TMap.MultiMarker({
          map: map,
        });
        window.polyline = new TMap.MultiPolyline({
          map: map,
        });
        window.polygon = new TMap.MultiPolygon({
          map: map,
        });
        var circle = new TMap.MultiCircle({
          map: map,
        });
        var rectangle = new TMap.MultiRectangle({
          map: map,
        });
        var ellipse = new TMap.MultiEllipse({
          map: map,
        });
        editor = new TMap.tools.GeometryEditor({
          // TMap.tools.GeometryEditor 文档地址：https://lbs.qq.com/webApi/javascriptGL/glDoc/glDocEditor
          map: map, // 编辑器绑定的地图对象
          overlayList: [
            // 可编辑图层 文档地址：https://lbs.qq.com/webApi/javascriptGL/glDoc/glDocEditor#4
            {
              overlay: marker,
              id: 'marker',
            },
            {
              overlay: polyline,
              id: 'polyline',
            },
            {
              overlay: polygon,
              id: 'polygon',
            },
            {
              overlay: circle,
              id: 'circle',
            },
            {
              overlay: rectangle,
              id: 'rectangle',
            },
            {
              overlay: ellipse,
              id: 'ellipse',
            },
          ],
          actionMode: TMap.tools.constants.EDITOR_ACTION.DRAW, // 编辑器的工作模式
          activeOverlayId: 'marker', // 激活图层
          snappable: true, // 开启吸附
        });
        // 监听绘制结束事件，获取绘制几何图形
        editor.on('draw_complete', (geometry) => {
          // 判断当前处于编辑状态的图层id是否是overlayList中id为rectangle（矩形）图层
          // 判断当前处于编辑状态的图层id是否是overlayList中id为rectangle（矩形）图层
          console.log(editor.getActiveOverlay().id)
          var id = geometry.id;
          if (editor.getActiveOverlay().id === 'rectangle') {
            // 获取矩形顶点坐标
            var geo = rectangle.geometries.filter(function (item) {
              return item.id === id;
            });
            console.log('绘制的矩形定位的坐标：', geo[0].paths);
          }

          if (editor.getActiveOverlay().id === 'polygon') {
            // 获取多边形顶点坐标
            var geo = polygon.geometries.filter(function (item) {
              return item.id === id;
            });
            console.log('绘制的多边形坐标：', geo[0].paths);
            document.getElementById('info').innerHTML =
              JSON.stringify(geo[0].paths);
          }
          // polyline
          if (editor.getActiveOverlay().id === 'polyline') {
            // 获取折线顶点坐标
            var geo = polyline.geometries.filter(function (item) {
              return item.id === id;
            });
            console.log('绘制的折线坐标：', geo[0].paths);
            document.getElementById('info').innerHTML =
              JSON.stringify(geo[0].paths);

          }
        });

        setupDragDrop();
      }

      // 拖拽入json文件 的支持
      function setupDragDrop() {
        var container = document.getElementById('container');
        if (!container) return;

        function preventDefault(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function (type) {
          container.addEventListener(type, preventDefault);
        });

        container.addEventListener('drop', function (e) {
          var files = e.dataTransfer && e.dataTransfer.files;
          if (!files || !files.length) return;
          var file = files[0];
          if (!/\.json$/i.test(file.name)) {
            console.warn('仅支持拖拽 .json 文件');
            return;
          }

          var reader = new FileReader();
          reader.onload = function () {
            var text = reader.result || '';
            var data = null;

            try {
              data = JSON.parse(text);
            } catch (err) {
              data = tryExtractJson(text);
            }

            if (!data) {
              console.error('JSON 解析失败');
              return;
            }

            printPolygon(data);
            if (Array.isArray(data)) {
              var center = computePolygonCenter(data);
              if (center && map) {
                map.setCenter(new TMap.LatLng(center.lat, center.lng));
                map.setZoom(12);
              }
            }
            if (Array.isArray(data)) {
              document.getElementById('info').innerHTML = JSON.stringify(data);
            }
          };
          reader.readAsText(file, 'utf-8');
        });
      }

      function tryExtractJson(text) {
        var first = text.search(/[\[{]/);
        if (first === -1) return null;
        var lastArray = text.lastIndexOf(']');
        var lastObj = text.lastIndexOf('}');
        var last = Math.max(lastArray, lastObj);
        if (last <= first) return null;
        var candidate = text.slice(first, last + 1);
        try {
          return JSON.parse(candidate);
        } catch (err) {
          return null;
        }
      }

      // 计算 多边形 中心点
      function computePolygonCenter(points) {
        if (!Array.isArray(points) || points.length === 0) return null;
        var pts = points
          .filter(function (p) {
            return p && typeof p.lng === 'number' && typeof p.lat === 'number';
          })
          .map(function (p) {
            return [p.lng, p.lat];
          });

        if (pts.length === 0) return null;
        if (pts.length < 3) {
          var sumLng = 0;
          var sumLat = 0;
          pts.forEach(function (p) {
            sumLng += p[0];
            sumLat += p[1];
          });
          return { lng: sumLng / pts.length, lat: sumLat / pts.length };
        }

        var area = 0;
        var cx = 0;
        var cy = 0;
        for (var i = 0; i < pts.length; i++) {
          var p0 = pts[i];
          var p1 = pts[(i + 1) % pts.length];
          var a = p0[0] * p1[1] - p1[0] * p0[1];
          area += a;
          cx += (p0[0] + p1[0]) * a;
          cy += (p0[1] + p1[1]) * a;
        }
        area *= 0.5;
        if (area === 0) {
          var avgLng = 0;
          var avgLat = 0;
          pts.forEach(function (p) {
            avgLng += p[0];
            avgLat += p[1];
          });
          return { lng: avgLng / pts.length, lat: avgLat / pts.length };
        }
        cx = cx / (6 * area);
        cy = cy / (6 * area);
        return { lng: cx, lat: cy };
      }

      // 绘制 json Polygon（支持 printPolygon(jsonArray) 或 printPolygon(...points)）
      function printPolygon() {
        var points = Array.prototype.slice.call(arguments);
        var list = points;
        if (points.length === 1 && Array.isArray(points[0])) {
          list = points[0];
        }

        var paths = list
          .filter(function (p) {
            return !!p;
          })
          .map(function (p) {
            if (p instanceof TMap.LatLng) return p;
            if (Array.isArray(p)) return new TMap.LatLng(p[1], p[0]); // [lng, lat]
            return new TMap.LatLng(p.lat, p.lng); // {lat, lng}
          });

        if (!polygon || paths.length === 0) return;

        polygon.setGeometries([
          {
            id: 'json-polygon',
            styleId: 'jsonStyle',
            paths: paths,
          },
        ]);
      }
    </script>
  </body>
</html>
